<?xml version='1.0' encoding='UTF-8'?>
<!--  See src/resources/configuration/ReadMe.txt for how the configuration assembly works -->
<config>
    <extension-module>org.wildfly.extension.messaging-activemq</extension-module>
    <subsystem xmlns="urn:jboss:domain:messaging-activemq:1.1">
        <server name="default">
            <journal
                    file-size="102400" />
            <?CLUSTERED?>

            <http-connector name="http-connector"
                            socket-binding="http">
                <param name="http-upgrade-endpoint"
                       value="http-acceptor"/>
            </http-connector>
            <http-connector name="http-connector-throughput"
                            socket-binding="http">
                <param name="http-upgrade-endpoint"
                       value="http-acceptor-throughput"/>
                <param name="batch-delay"
                       value="50"/>
            </http-connector>
            <in-vm-connector name="in-vm"
                             server-id="0"/>

            <http-acceptor name="http-acceptor"
                           http-listener="default" />
            <http-acceptor name="http-acceptor-throughput"
                           http-listener="default">
                <param name="batch-delay"
                       value="50"/>
                <param name="direct-deliver"
                       value="false"/>
            </http-acceptor>
            <in-vm-acceptor name="in-vm"
                            server-id="${my.server-id:0}"/>

            <?BROADCAST-GROUPS?>
            <?DISCOVERY-GROUPS?>
            <?CLUSTER-CONNECTIONS?>

            <security-setting name="#">
                <role name="guest"
                      send="true"
                      consume="true"
                      create-non-durable-queue="true"
                      delete-non-durable-queue="true"/>
            </security-setting>

            <address-setting name="#"
                             dead-letter-address="jms.queue.DLQ"
                             expiry-address="jms.queue.ExpiryQueue"
            <?REDISTRIBUTION-DELAY?>
            max-size-bytes="10485760"
            page-size-bytes="2097152"
            message-counter-history-day-limit="10">

            <connection-factory name="InVmConnectionFactory"
                                connectors="in-vm"
                                entries="java:/ConnectionFactory" />
            <connection-factory name="RemoteConnectionFactory"
                                connectors="http-connector"
                                entries="java:jboss/exported/jms/RemoteConnectionFactory" />
            <?HA-REMOTE-CONNECTION-FACTORY?>
            <pooled-connection-factory name="hornetq-ra"
                                       transaction="xa"
                                       connectors="in-vm"
                                       entries="java:/JmsXA, java:jboss/DefaultJMSConnectionFactory"/>
            <jms-queue name="ExpiryQueue"
                       entries="java:/jms/queue/ExpiryQueue" />
            <jms-queue name="DLQ"
                       entries="java:/jms/queue/DLQ" />
        </server>
    </subsystem>
    <supplement name="ha">
        <replacement placeholder="CLUSTERED">
            <cluster-password>${jboss.messaging.cluster.password:CHANGE ME!!}</cluster-password>
        </replacement>
        <replacement placeholder="BROADCAST-GROUPS">
            <broadcast-groups>
                <broadcast-group name="bg-group1">
                    <socket-binding>messaging-group</socket-binding>
                    <connector-ref>http-connector</connector-ref>
                </broadcast-group>
            </broadcast-groups>
        </replacement>
        <replacement placeholder="DISCOVERY-GROUPS">
            <discovery-groups>
                <discovery-group name="dg-group1">
                    <socket-binding>messaging-group</socket-binding>
                </discovery-group>
            </discovery-groups>
        </replacement>
        <replacement placeholder="CLUSTER-CONNECTIONS">
            <cluster-connections>
                <cluster-connection name="my-cluster">
                    <address>jms</address>
                    <connector-ref>http-connector</connector-ref>
                    <discovery-group-ref discovery-group-name="dg-group1"/>
                </cluster-connection>
            </cluster-connections>
        </replacement>
        <replacement placeholder="REDISTRIBUTION-DELAY">
            <redistribution-delay>1000</redistribution-delay>
        </replacement>
        <replacement placeholder="HA-REMOTE-CONNECTION-FACTORY">
            <ha>true</ha>
            <block-on-acknowledge>true</block-on-acknowledge>
            <reconnect-attempts>-1</reconnect-attempts>
        </replacement>
    </supplement>

    <socket-binding name="messaging-group" port="0" multicast-address="${jboss.messaging.group.address:231.7.7.7}" multicast-port="${jboss.messaging.group.port:9876}"/>
</config>
