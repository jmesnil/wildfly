<?xml version='1.0' encoding='UTF-8'?>
<!--  See src/resources/configuration/ReadMe.txt for how the configuration assembly works -->
<config>
    <extension-module>org.jboss.as.messaging</extension-module>
    <subsystem xmlns="urn:jboss:domain:messaging:2.0">
        <hornetq-server name="live">
            <?LIVE_CONFIG_BACKUP_GROUP_NAME?>
            <?LIVE_CONFIG?>
            <?COMMON_CONFIG?>
        </hornetq-server>
        <hornetq-server name="backup">
            <?BACKUP_CONFIG_BACKUP_GROUP_NAME?>
            <?BACKUP_CONFIG?>
            <?COMMON_CONFIG?>
        </hornetq-server>
    </subsystem>
    <supplement name="common-config">
        <replacement placeholder="LIVE_CONFIG">
            <backup>false</backup>
            <check-for-live-server>true</check-for-live-server>
            <shared-store>false</shared-store>
            <journal-directory path="live/messagingjournal" />
            <paging-directory path="live/messagingpaging" />
            <bindings-directory path="live/messagingbindings" />
            <large-messages-directory path="live/messaginglargemessages" />

            <connectors>
                <http-connector name="http-connector" socket-binding="http">
                    <param key="http-upgrade-endpoint" value="http-acceptor-live"/>
                </http-connector>
                <in-vm-connector name="in-vm" server-id="0"/>
            </connectors>

            <acceptors>
                <http-acceptor name="http-acceptor-live" http-listener="default"/>
                <in-vm-acceptor name="in-vm" server-id="0"/>
            </acceptors>
        </replacement>
        <replacement placeholder="BACKUP_CONFIG">
            <backup>true</backup>
            <check-for-live-server>true</check-for-live-server>
            <shared-store>false</shared-store>
            <journal-directory path="backup/messagingjournal" />
            <paging-directory path="backup/messagingpaging" />
            <bindings-directory path="backup/messagingbindings" />
            <large-messages-directory path="backup/messaginglargemessages" />

            <connectors>
                <http-connector name="http-connector" socket-binding="http">
                    <param key="http-upgrade-endpoint" value="http-acceptor-backup"/>
                </http-connector>
                <in-vm-connector name="in-vm" server-id="1"/>
            </connectors>

            <acceptors>
                <http-acceptor name="http-acceptor-backup" http-listener="default"/>
                <in-vm-acceptor name="in-vm" server-id="1"/>
            </acceptors>
        </replacement>
        <replacement placeholder="COMMON_CONFIG">
            <cluster-password>${jboss.messaging.cluster.password:CHANGE ME!!}</cluster-password>
            <journal-file-size>102400</journal-file-size>

            <broadcast-groups>
                <broadcast-group name="bg-group1">
                    <socket-binding>messaging-group</socket-binding>
                    <connector-ref>
                        http-connector
                    </connector-ref>
                </broadcast-group>
            </broadcast-groups>

            <discovery-groups>
                <discovery-group name="dg-group1">
                    <socket-binding>messaging-group</socket-binding>
                </discovery-group>
            </discovery-groups>

            <cluster-connections>
                <cluster-connection name="my-cluster">
                    <address>jms</address>
                    <connector-ref>http-connector</connector-ref>
                    <discovery-group-ref discovery-group-name="dg-group1"/>
                </cluster-connection>
            </cluster-connections>

            <security-settings>
                <security-setting match="#">
                    <permission type="send" roles="guest"/>
                    <permission type="consume" roles="guest"/>
                    <permission type="createNonDurableQueue" roles="guest"/>
                    <permission type="deleteNonDurableQueue" roles="guest"/>
                </security-setting>
            </security-settings>

            <address-settings>
                <address-setting match="#">
                    <dead-letter-address>jms.queue.DLQ</dead-letter-address>
                    <expiry-address>jms.queue.ExpiryQueue</expiry-address>
                    <max-size-bytes>10485760</max-size-bytes>
                    <page-size-bytes>2097152</page-size-bytes>
                    <message-counter-history-day-limit>10</message-counter-history-day-limit>
                    <redistribution-delay>1000</redistribution-delay>
                </address-setting>
            </address-settings>

            <jms-connection-factories>
                <connection-factory name="InVmConnectionFactory">
                    <connectors>
                        <connector-ref connector-name="in-vm"/>
                    </connectors>
                    <entries>
                        <entry name="java:/ConnectionFactory"/>
                    </entries>
                </connection-factory>
                <connection-factory name="RemoteConnectionFactory">
                    <connectors>
                        <connector-ref connector-name="http-connector"/>
                    </connectors>
                    <entries>
                        <entry name="java:jboss/exported/jms/RemoteConnectionFactory"/>
                    </entries>
                    <ha>true</ha>
                    <block-on-acknowledge>true</block-on-acknowledge>
                    <reconnect-attempts>-1</reconnect-attempts>
                </connection-factory>
                <pooled-connection-factory name="hornetq-ra">
                    <transaction mode="xa"/>
                    <connectors>
                        <connector-ref connector-name="in-vm"/>
                    </connectors>
                    <entries>
                        <entry name="java:/JmsXA"/>
                        <entry name="java:jboss/DefaultJMSConnectionFactory"/>
                    </entries>
                </pooled-connection-factory>
            </jms-connection-factories>

            <jms-destinations>
                <jms-queue name="ExpiryQueue">
                    <entry name="java:/jms/queue/ExpiryQueue"/>
                </jms-queue>
                <jms-queue name="DLQ">
                    <entry name="java:/jms/queue/DLQ"/>
                </jms-queue>
                <jms-queue name="queueA">
                    <entry name="java:jboss/exported/jms/queueA"/>
                </jms-queue>
            </jms-destinations>
        </replacement>
    </supplement>
    <supplement name="main-full-ha" includes="common-config">
        <replacement placeholder="LIVE_CONFIG_BACKUP_GROUP_NAME">
            <backup-group-name>main-messaging-group</backup-group-name>
        </replacement>
        <replacement placeholder="BACKUP_CONFIG_BACKUP_GROUP_NAME">
            <backup-group-name>other-messaging-group</backup-group-name>
        </replacement>
    </supplement>
    <supplement name="other-full-ha" includes="common-config">
        <replacement placeholder="LIVE_CONFIG_BACKUP_GROUP_NAME">
            <backup-group-name>other-messaging-group</backup-group-name>
        </replacement>
        <replacement placeholder="BACKUP_CONFIG_BACKUP_GROUP_NAME">
            <backup-group-name>main-messaging-group</backup-group-name>
        </replacement>
    </supplement>

    <socket-binding name="messaging-group" port="0" multicast-address="${jboss.messaging.group.address:231.7.7.7}" multicast-port="${jboss.messaging.group.port:9876}"/>
</config>
